---
title: "Botany of Cactus Allocation"
author: "Malory Owen & Christopher Lortie"
date: "2019"
output:
  html_document:
    toc: true
    toc_float: true

---


```{r, setup, include=FALSE}
#Bring in libraries
library(tidyr)
library(ggplot2)
library(ggmap)
library(dplyr)
library(lmerTest)
library(caret)
library(ggpubr)

register_google(key='')
```

##Dataset
```{r, datasets}
#Bring in datasets of interest
paired <- read.csv('~/Masters/Botany-of-Cactus-Allocation/data/paired_flower_fruit.csv')
head(paired)

fruit_metrics <- read.csv("~/Masters/Botany-of-Cactus-Allocation/data/fruit_metrics.csv")
head(fruit_metrics)

seed_metrics <- read.csv("~/Masters/Botany-of-Cactus-Allocation/data/seed_metrics.csv")
head(seed_metrics)


```

##Viz
###Maps
```{r, viz, warning=FALSE}
#map
cali <- get_map(location = c(lon = -115.662, lat = 34.7812), zoom = 19)
map <- ggmap(cali) #basemap

allomap <- map +
  geom_point(data=paired, aes(x=lon, y=lat), alpha = .5, size=2) +
  labs(x = "longitude", y = "latitude", title = "Sampled Cacti for Allocation Observations")
allomap



```

###Size

####Visuals of metrics
```{r, means, warning=FALSE}
barnew <- ggplot(paired, aes(x=transect, y=newgrowth)) +
  geom_bar(stat="identity") + theme_minimal()

barvol <- ggplot(paired, aes(x=transect, y=volume)) +
  geom_bar(stat="identity") + theme_minimal()

barbra <- ggplot(paired, aes(x=transect, y=branches)) +
  geom_bar(stat="identity") + theme_minimal()

barbud <- ggplot(paired, aes(x=transect, y=buds)) +
  geom_bar(stat="identity") + theme_minimal()

barfru <- ggplot(paired, aes(x=transect, y=fruits)) +
  geom_bar(stat='identity') + theme_minimal()

bars <- ggarrange(barvol, barnew, barbra, barbud, barfru, ncol = 3, nrow = 2)
bars

```


####Absolute Size
Here we examine different metrics for total size of a cactus against the reproductive output for each cactus (as represented by total number of floral buds).

```{r, datamanipu, include=FALSE}
#Get log of volume 
paired <- mutate(paired, logvol=(log(volume))) 
paired <- mutate(paired, logbra=(log(branches)))
paired <- mutate(paired, lognew=log(newgrowth))

pairedsc <- pivot_longer(paired, col = c("logvol", "lognew", "logbra"), names_to = "metric", values_to = "metric.value")

```

```{r, size, warning=FALSE}
#size
#three metrics: volume, new growth, branches

size_scatter <- ggplot(pairedsc, aes(x = metric.value, y = buds)) +
  geom_point() + labs(x = "Metric", y = "Reproductive Output") + facet_grid(.~metric) + theme_minimal()
size_scatter

#volume
volume <- ggplot(paired, aes(volume)) +
  geom_density() +
  labs(x = "Total Volume") + theme_minimal()

volumebuds <- ggplot(paired, aes(volume, buds)) +
  geom_point() + geom_smooth(method="glm", formula=y~x) +
  labs(x = "Total Volume", y = "Reproductive Output") + theme_minimal() 


#new growth
newgrowth <- ggplot(paired, aes(newgrowth)) +
  geom_density() +
  labs(x = "New Growth Branches") + theme_minimal()

newgrowthbuds <- ggplot(paired, aes(newgrowth, buds)) +
  geom_point() + geom_smooth(method="glm", formula=y~x) +
  labs(x = "New Growth Branches", y = "Reproductive Output") + theme_minimal()


#branches
branches <- ggplot(paired, aes(branches)) +
  geom_density() + 
  labs(x = "Total Branches") + theme_minimal()

branchesbuds <- ggplot(paired, aes(branches, buds)) +
  geom_point() + geom_smooth(method="glm", formula=y~x) +
  labs(x = "Total Branches", y = "Reproductive Output") + theme_minimal()


sizebuds <- ggarrange(volumebuds, newgrowthbuds, branchesbuds, ncol = 2, nrow = 2)
sizebuds

densities <- ggarrange(volume, newgrowth, branches, ncol = 2, nrow = 2)
densities

```
There is a large skew for smaller plants in our sampling resulting in a Poisson Distribution, which makes it difficult to know if there is actually a trade off in allocation happening.  

####Per Capita Size
Because it stands that larger plants have more branches, and therefore, more apical nodes from which buds can grow, we should investigate buds-per-branch as a standardized metric for reproductive output.
```{r, per capita, warning=FALSE}
#add buds per branch column
paired <- mutate(paired, budsperbranch = buds/branches)
head(paired)

#volume
volumebudsper <- ggplot(paired, aes(volume, budsperbranch)) +
  geom_point() + geom_smooth(method="glm", formula=y~x)
  labs(x = "Total Volume", y = "Reproductive Output per Branch") + theme_minimal()

#new growth
newgrowthbudsper <- ggplot(paired, aes(budsperbranch, newgrowth)) +
  geom_point() + geom_smooth(method="glm", formula=y~x)
  labs(x = "New Growth Branches", y = "Reproductive Output per Branch") + theme_minimal()

#branches
branchesbudsper <- ggplot(paired, aes(budsperbranch, branches)) +
  geom_point() + geom_smooth(method="glm", formula=y~x)
  labs(x = "Total Branches", y = "Reproductive Output per Branch") + theme_minimal()

sizebudsper <- ggarrange(volumebudsper, newgrowthbudsper, branchesbudsper, ncol = 2, nrow = 2)
sizebudsper


```
Even with accounting for buds/branch, the scatterplots of any size metric and buds as a reproductive output are funnel shaped. All this means is that future statistical models need to be built for a Poisson distribution.


```{r}

```


####Distributions of and relationships between reproductive outputs
```{r, repro output viz, warning=FALSE}
buds <- ggplot(paired, aes(x=buds)) + geom_density()
fruits <- ggplot(paired, aes(x=fruits)) + geom_density()

repro <- ggarrange(buds, fruits, ncol = 2, nrow = 1)
repro

#Buds and fruits
bf <- ggplot(paired, aes(x=buds, y=fruits)) +
  geom_smooth(model = "glm", formula=y~x) + theme_minimal()
bf
```


##Models
###Allocation between physical and reproductive structures
```{r, allocation models, warning=FALSE}
#Test for correlation between factors
vncor <- cor.test(paired$volume, paired$newgrowth, method="pearson")
vncor #correlated
vbcor <- cor.test(paired$volume, paired$branches, method="pearson")
vbcor #correlated
nbcor <- cor.test(paired$newgrowth, paired$branches, method="pearson")
nbcor #correlated
#All predictors are correlated, so I believe we don't want interacting models. 

#Volume as a predictor for repro output
m1 <- glm(buds~volume, data=paired, family="poisson")
summary(m1)

#New growth as predictor for repro output
m2 <- glm(buds~newgrowth, data=paired, family="poisson")
summary(m2)

#Number of branches as predictor for repro output
m3 <- glm(buds~branches, data=paired, family="poisson")
summary(m3)

#All are significant, so let's include all in one model
m4 <- glm(buds~newgrowth + volume + branches, data=paired, family="poisson")
summary(m4)

#posthoc of model that includes all factors
anova(m4, test="Chisq")

m5 <- glm(buds~newgrowth * volume * branches, data=paired, family="poisson")
summary(m5)

#posthoc of model with all factors interactors 
anova(m5, test="Chisq")

#Let's have volume (and then again number of branches) be considered as random factors, and try some GLMMs. 

m6 <- glmer(buds~newgrowth + (1|volume) + (1|branches), data=paired, family="poisson")
anova(m6, test="Chisq")
```

###Relationships between reproductive structures
We have several different metrics for reproductive structure. As of now, available metrics are: 1) number of buds, 2) blooming/not blooming as of June 8th, and 3) number of fruits. We are still collecting the data on 4) seed weight, 5) seed count, 6) fruit size, and 7) fruit weight. 

####Reproductive output counts
```{r, reproductive models, error=FALSE, warning=FALSE}


bfcor <- cor.test(paired$buds, paired$fruits, method="pearson")
bfcor #correlated
bbcor <- cor.test(paired$blooms, paired$fruits, method="pearson")
bbcor #correlated


m7<- glm(buds~fruits, data=paired, family="poisson")
summary(m7)



```

Binomial glm models gave errors, but if we can get them to work, we can also see the relationship between blooms and other metrics, as well as the presence/absence of Cactus Wren nests.

Next steps: expand models to include seed weight, seed count, fruit size, and fruit abundance. Identify what the middle/end to this story exactly is. 

